<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Thermostat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <style>
        /* Settings-specific styles */
        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .setting-item {
            padding: 15px;
            margin-bottom: 10px;
            background: var(--sensor-bg);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-item > div > label {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
            margin-bottom: 5px;
        }

        .setting-description {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
            line-height: 1.4;
        }

        .setting-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sensor-list {
            display: grid;
            gap: 15px;
        }

        .sensor-card {
            padding: 20px;
            background: var(--sensor-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sensor-id {
            font-family: monospace;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .sensor-controls {
            display: grid;
            gap: 10px;
        }

        .sensor-control-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .sensor-control-row label {
            min-width: 120px;
            font-weight: 500;
        }

        .sensor-control-row input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            color: var(--text-primary);
            font-size: 1em;
        }

        .sensor-control-row input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .save-button {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .save-button:hover {
            background: #2ecc71;
            transform: translateY(-1px);
        }

        .save-button:active {
            transform: translateY(0);
        }

        .save-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .radio-label input[type="radio"] {
            cursor: pointer;
        }

        .info-box {
            padding: 15px;
            background: var(--info-bg);
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .info-box p {
            margin: 5px 0;
            line-height: 1.5;
        }

        .info-box strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .success-message, .error-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Stage configuration styles */
        .stage-control-row {
            display: grid;
            grid-template-columns: 80px 70px 90px 110px 120px 1fr 80px 100px;
            gap: 10px;
            align-items: center;
            padding: 12px;
            background: var(--sensor-bg);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .stage-control-row:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stage-control-row label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.85em;
            display: block;
            margin-bottom: 2px;
        }

        .stage-control-row input[type="number"],
        .stage-control-row input[type="text"] {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 0.95em;
            width: 100%;
        }

        .stage-control-row input[type="number"]:focus,
        .stage-control-row input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stage-control-row .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }

        .stage-control-row .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        .stage-header {
            display: grid;
            grid-template-columns: 80px 70px 90px 110px 120px 1fr 80px 100px;
            gap: 10px;
            padding: 10px 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .stage-header div:nth-child(7) {
            text-align: center;
        }

        .delete-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .delete-button:hover {
            background: #c0392b;
        }

        /* Dark mode improvements */
        @media (prefers-color-scheme: dark) {
            :root:not(.light-mode) .info-box {
                background: rgba(102, 126, 234, 0.15);
                border-left-color: #a78bfa;
                color: #e2e8f0;
            }

            :root:not(.light-mode) .sensor-card {
                background: #1f2937;
                border-color: #374151;
            }

            :root:not(.light-mode) .setting-item {
                background: #1f2937;
            }

            :root:not(.light-mode) .setting-item > div > label {
                color: #f3f4f6;
            }

            :root:not(.light-mode) .sensor-control-row label,
            :root:not(.light-mode) .stage-control-row label,
            :root:not(.light-mode) .setting-item label {
                color: #e2e8f0;
            }

            :root:not(.light-mode) .sensor-control-row input[type="text"],
            :root:not(.light-mode) .stage-control-row input[type="number"],
            :root:not(.light-mode) .stage-control-row input[type="text"] {
                background: #1f2937;
                border: 1px solid #4b5563;
                color: #f3f4f6;
            }

            :root:not(.light-mode) .stage-control-row:hover {
                background: #2d3748;
            }

            :root:not(.light-mode) .stage-control-row input[type="number"]:focus,
            :root:not(.light-mode) .stage-control-row input[type="text"]:focus {
                border-color: #a78bfa;
                background: #111827;
                box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
            }

            :root:not(.light-mode) .delete-button {
                background: #dc2626;
            }

            :root:not(.light-mode) .delete-button:hover {
                background: #b91c1c;
            }

            :root:not(.light-mode) .stage-control-row strong {
                color: #f3f4f6;
            }

            :root:not(.light-mode) .sensor-id {
                color: #9ca3af;
            }

            :root:not(.light-mode) .setting-description {
                color: #cbd5e0;
            }

            :root:not(.light-mode) .sensor-header strong {
                color: #f3f4f6;
            }

            :root:not(.light-mode) .success-message {
                background: rgba(72, 187, 120, 0.2);
                color: #86efac;
                border-color: #48bb78;
            }

            :root:not(.light-mode) .error-message {
                background: rgba(245, 101, 101, 0.2);
                color: #fca5a5;
                border-color: #f56565;
            }
        }

        /* Light mode explicit overrides */
        .light-mode .stage-control-row input[type="number"],
        .light-mode .stage-control-row input[type="text"],
        .light-mode .sensor-control-row input[type="text"] {
            background: white;
            border: 1px solid #e2e8f0;
            color: #333;
        }

        :root.dark-mode .info-box {
            background: rgba(102, 126, 234, 0.15);
            border-left-color: #a78bfa;
            color: #e2e8f0;
        }

        :root.dark-mode .sensor-card {
            background: #1f2937;
            border-color: #374151;
        }

        :root.dark-mode .setting-item {
            background: #1f2937;
        }

        :root.dark-mode .setting-item > div > label {
            color: #f3f4f6;
        }

        :root.dark-mode .sensor-control-row label,
        :root.dark-mode .setting-item label {
            color: #e2e8f0;
        }

        :root.dark-mode .sensor-control-row input[type="text"] {
            background: #374151;
            border: 1px solid #4b5563;
            color: #e2e8f0;
        }

        :root.dark-mode .sensor-id {
            color: #9ca3af;
        }

        :root.dark-mode .setting-description {
            color: #cbd5e0;
        }

        :root.dark-mode .sensor-header strong {
            color: #f3f4f6;
        }

        :root.dark-mode .success-message {
            background: rgba(72, 187, 120, 0.2);
            color: #86efac;
            border-color: #48bb78;
        }

        :root.dark-mode .error-message {
            background: rgba(245, 101, 101, 0.2);
            color: #fca5a5;
            border-color: #f56565;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .sensor-control-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .sensor-control-row label {
                min-width: auto;
            }

            .sensor-control-row input[type="text"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <div class="hamburger" onclick="toggleNav()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="nav-links" id="nav-links">
                <a href="/">Dashboard</a>
                <a href="/schedules">Schedules</a>
                <a href="/history" class="history-toggle collapsed" onclick="toggleHistoryMenu(event)">History</a>
                <!-- History sub-navigation (mobile only) -->
                <div class="history-subnav" id="history-subnav">
                    <a href="/history#stats">üìä Stats</a>
                    <a href="/history#settings">‚öôÔ∏è Settings</a>
                    <a href="/history#hvac">üî• HVAC</a>
                    <a href="/history#sensors">üå°Ô∏è Sensors</a>
                </div>
                <a href="/settings" class="active">Settings</a>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
                <span id="theme-icon">üåô</span>
            </button>
        </div>

        <div id="messages"></div>

        <!-- Temperature Units Section -->
        <section class="settings-section">
            <div class="card">
                <h2>Display Preferences</h2>
                
                <div class="setting-item">
                    <div>
                        <label>Temperature Units</label>
                        <div class="setting-description">Choose how temperatures are displayed throughout the interface</div>
                    </div>
                    <div class="setting-control">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="units" value="F" id="units-f">
                                Fahrenheit (¬∞F)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="units" value="C" id="units-c">
                                Celsius (¬∞C)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="units" value="K" id="units-k">
                                Kelvin (K)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="setting-item">
                    <div>
                        <label>Theme Mode</label>
                        <div class="setting-description">Choose between light mode, dark mode, or follow system preference</div>
                    </div>
                    <div class="setting-control">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="theme" value="auto" id="theme-auto">
                                Auto (System)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="theme" value="light" id="theme-light">
                                Light
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="theme" value="dark" id="theme-dark">
                                Dark
                            </label>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="save-button" id="save-prefs-button" onclick="saveDisplayPreferences()">
                        Save Display Preferences
                    </button>
                </div>
            </div>
        </section>

        <!-- HVAC Stage Configuration Section -->
        <section class="settings-section">
            <div class="card">
                <h2>HVAC Stage Configuration</h2>
                
                <div class="info-box">
                    <p><strong>Multi-Stage HVAC:</strong> Configure heating and cooling stages for complex HVAC systems</p>
                    <p><strong>Stage Number:</strong> Stages activate progressively (1, then 2, then 3, etc.) based on temperature need</p>
                    <p><strong>GPIO Pin:</strong> BCM pin number controlling the relay for this stage</p>
                    <p><strong>Temp Offset:</strong> Temperature difference from target needed to activate this stage (stored internally as ¬∞C)</p>
                    <p><strong>Min Run Time:</strong> Minimum seconds stage must run before shutting off (prevents short-cycling)</p>
                </div>

                <div class="stage-list" id="stage-list">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        Loading stages...
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="save-button" onclick="showAddStageDialog()">
                        Add New Stage
                    </button>
                </div>
            </div>
        </section>

        <!-- Sensor Configuration Section -->
        <section class="settings-section">
            <div class="card">
                <h2>Sensor Configuration</h2>
                
                <div class="info-box">
                    <p><strong>Sensor Names:</strong> Give each sensor a meaningful name (e.g., "Living Room", "Bedroom")</p>
                    <p><strong>Enabled:</strong> Include sensor in temperature calculations. Enabled sensors are automatically monitored for
                        anomalies like rapid temperature changes (e.g., fireplace turning on) and will be temporarily excluded from HVAC
                        control when anomalies are detected.</p>
                </div>

                <div class="sensor-list" id="sensor-list">
                    <!-- Sensors will be loaded here dynamically -->
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        Loading sensors...
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script>
        let currentSensors = [];
        let currentStages = [];
        let currentUnits = 'F';  // Default to Fahrenheit

        // Temperature conversion functions
        // NOTE: These convert temperature DIFFERENCES (deltas), not absolute temperatures
        // For deltas, we don't add/subtract the offset (32 for F, 273.15 for K)
        function celsiusToUser(tempC, units) {
            if (units === 'F') {
                return tempC * 9/5;  // Just the ratio, no +32 for differences
            } else if (units === 'K') {
                return tempC;  // Kelvin and Celsius have same delta
            }
            return tempC;  // Already Celsius
        }

        function userToCelsius(temp, units) {
            if (units === 'F') {
                return temp * 5/9;  // Just the ratio, no -32 for differences
            } else if (units === 'K') {
                return temp;  // Kelvin and Celsius have same delta
            }
            return temp;  // Already Celsius
        }

        function getUnitSymbol(units) {
            return units === 'F' ? '¬∞F' : (units === 'K' ? 'K' : '¬∞C');
        }

        // Show message to user
        function showMessage(message, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isError ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, 5000);
        }

        // Load current temperature units and theme preferences
        async function loadUnits() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                currentUnits = data.temperature_units || 'F';
                
                document.getElementById(`units-${currentUnits.toLowerCase()}`).checked = true;
                
                // Load theme preference
                const savedTheme = localStorage.getItem('theme') || 'auto';
                document.getElementById(`theme-${savedTheme}`).checked = true;
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }

        // Load sensors
        async function loadSensors() {
            try {
                const response = await fetch('/api/sensors/config');
                const data = await response.json();
                currentSensors = data.sensors || [];
                
                renderSensors();
            } catch (error) {
                console.error('Error loading sensors:', error);
                showMessage('Error loading sensors: ' + error.message, true);
            }
        }

        // Render sensor list
        function renderSensors() {
            const container = document.getElementById('sensor-list');
            
            if (currentSensors.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No sensors configured. Sensors will appear here when detected.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            currentSensors.forEach(sensor => {
                const card = document.createElement('div');
                card.className = 'sensor-card';
                card.innerHTML = `
                    <div class="sensor-header">
                        <div>
                            <strong>${escapeHtml(sensor.name || sensor.sensor_id)}</strong>
                            <div class="sensor-id">${escapeHtml(sensor.sensor_id)}</div>
                        </div>
                    </div>
                    <div class="sensor-controls">
                        <div class="sensor-control-row">
                            <label for="name-${escapeHtml(sensor.sensor_id)}">Display Name:</label>
                            <input 
                                type="text" 
                                id="name-${escapeHtml(sensor.sensor_id)}"
                                value="${escapeHtml(sensor.name || '')}"
                                placeholder="e.g., Living Room"
                                data-sensor-id="${escapeHtml(sensor.sensor_id)}"
                            >
                        </div>
                        <div class="sensor-control-row">
                            <label class="checkbox-label">
                                <input 
                                    type="checkbox" 
                                    id="enabled-${escapeHtml(sensor.sensor_id)}"
                                    ${sensor.enabled ? 'checked' : ''}
                                    data-sensor-id="${escapeHtml(sensor.sensor_id)}"
                                >
                                Enabled (include in temperature calculations)
                            </label>
                        </div>
                        <div class="sensor-control-row">
                            <button 
                                class="save-button" 
                                onclick="saveSensor('${escapeHtml(sensor.sensor_id)}')"
                            >
                                Save Changes
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Save sensor configuration
        async function saveSensor(sensorId) {
            const nameInput = document.getElementById(`name-${sensorId}`);
            const enabledInput = document.getElementById(`enabled-${sensorId}`);
            
            const saveButton = event.target;
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            
            try {
                const response = await fetch(`/api/sensors/config/${encodeURIComponent(sensorId)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: nameInput.value,
                        enabled: enabledInput.checked,
                        monitored: enabledInput.checked  // Automatically match enabled state
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save sensor');
                }
                
                showMessage(`Sensor "${nameInput.value || sensorId}" saved successfully`);
                
                // Update local data
                const sensor = currentSensors.find(s => s.sensor_id === sensorId);
                if (sensor) {
                    sensor.name = nameInput.value;
                    sensor.enabled = enabledInput.checked;
                    sensor.monitored = monitoredInput.checked;
                }
                
            } catch (error) {
                console.error('Error saving sensor:', error);
                showMessage('Error saving sensor: ' + error.message, true);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== HVAC STAGE MANAGEMENT =====
        
        // Load HVAC stages
        async function loadStages() {
            try {
                const response = await fetch('/api/hvac-stages');
                const data = await response.json();
                currentStages = data || [];
                
                renderStages();
            } catch (error) {
                console.error('Error loading stages:', error);
                showMessage('Error loading HVAC stages: ' + error.message, true);
            }
        }

        // Render stage list
        function renderStages() {
            const container = document.getElementById('stage-list');
            
            if (currentStages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No HVAC stages configured yet. Click "Add New Stage" to configure your HVAC system.
                    </div>
                `;
                return;
            }
            
            // Sort stages by type and number
            const sortedStages = [...currentStages].sort((a, b) => {
                if (a.stage_type !== b.stage_type) {
                    return a.stage_type === 'heat' ? -1 : 1;
                }
                return a.stage_number - b.stage_number;
            });
            
            container.innerHTML = `
                <div class="stage-header">
                    <div>Type</div>
                    <div>Stage</div>
                    <div>GPIO Pin</div>
                    <div>Temp Offset (${getUnitSymbol(currentUnits)})</div>
                    <div>Min Run Time (s)</div>
                    <div>Description</div>
                    <div>Enabled</div>
                    <div>Actions</div>
                </div>
            `;
            
            sortedStages.forEach(stage => {
                // Convert temp_offset from Celsius to user units for display
                const tempOffsetDisplay = celsiusToUser(stage.temp_offset, currentUnits);
                
                const row = document.createElement('div');
                row.className = 'stage-control-row';
                row.innerHTML = `
                    <div><strong>${stage.stage_type.toUpperCase()}</strong></div>
                    <div><input type="number" value="${stage.stage_number}" onchange="updateStage(${stage.id}, 'stage_number', this.value)" min="1" max="10"></div>
                    <div><input type="number" value="${stage.gpio_pin}" onchange="updateStage(${stage.id}, 'gpio_pin', this.value)" min="0" max="27"></div>
                    <div><input type="number" step="0.1" value="${tempOffsetDisplay.toFixed(2)}" onchange="updateStageTempOffset(${stage.id}, this.value)" min="0" max="${currentUnits === 'F' ? 18 : 10}"></div>
                    <div><input type="number" value="${stage.min_run_time}" onchange="updateStage(${stage.id}, 'min_run_time', this.value)" min="60" max="3600"></div>
                    <div><input type="text" value="${escapeHtml(stage.description || '')}" onchange="updateStage(${stage.id}, 'description', this.value)" placeholder="e.g., Primary heat"></div>
                    <div>
                        <label class="checkbox-label">
                            <input type="checkbox" ${stage.enabled ? 'checked' : ''} onchange="updateStage(${stage.id}, 'enabled', this.checked)">
                        </label>
                    </div>
                    <div>
                        <button class="delete-button" onclick="deleteStage(${stage.id})">Delete</button>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // Update stage temperature offset (needs conversion)
        async function updateStageTempOffset(stageId, valueInUserUnits) {
            // Convert from user units to Celsius for storage
            const valueInCelsius = userToCelsius(parseFloat(valueInUserUnits), currentUnits);
            await updateStage(stageId, 'temp_offset', valueInCelsius);
        }

        // Update stage field
        async function updateStage(stageId, field, value) {
            try {
                const response = await fetch(`/api/hvac-stages/${stageId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update stage');
                }
                
                // Update local data
                const stage = currentStages.find(s => s.id === stageId);
                if (stage) {
                    stage[field] = value;
                }
                
                showMessage('Stage updated successfully');
            } catch (error) {
                console.error('Error updating stage:', error);
                showMessage('Error updating stage: ' + error.message, true);
                // Reload to show original value
                loadStages();
            }
        }

        // Delete stage
        async function deleteStage(stageId) {
            if (!confirm('Are you sure you want to delete this HVAC stage? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hvac-stages/${stageId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete stage');
                }
                
                showMessage('Stage deleted successfully');
                loadStages();
            } catch (error) {
                console.error('Error deleting stage:', error);
                showMessage('Error deleting stage: ' + error.message, true);
            }
        }

        // Show add stage dialog
        function showAddStageDialog() {
            const stageType = prompt('Enter stage type (heat or cool):');
            if (!stageType || !['heat', 'cool'].includes(stageType.toLowerCase())) {
                if (stageType !== null) {
                    alert('Invalid stage type. Must be "heat" or "cool".');
                }
                return;
            }
            
            const stageNumber = prompt('Enter stage number (1, 2, 3, etc.):');
            if (!stageNumber || isNaN(stageNumber) || stageNumber < 1) {
                if (stageNumber !== null) {
                    alert('Invalid stage number. Must be a positive integer.');
                }
                return;
            }
            
            const gpioPin = prompt('Enter GPIO pin number:');
            if (!gpioPin || isNaN(gpioPin) || gpioPin < 0) {
                if (gpioPin !== null) {
                    alert('Invalid GPIO pin. Must be a non-negative integer.');
                }
                return;
            }
            
            const tempOffsetPrompt = prompt(`Enter temperature offset in ${getUnitSymbol(currentUnits)} (e.g., 0.5 for activation when ${currentUnits === 'F' ? '0.5¬∞F' : '0.5¬∞C'} above target):`);
            if (!tempOffsetPrompt || isNaN(tempOffsetPrompt)) {
                if (tempOffsetPrompt !== null) {
                    alert('Invalid temperature offset. Must be a number.');
                }
                return;
            }
            
            // Convert user input to Celsius for storage
            const tempOffsetCelsius = userToCelsius(parseFloat(tempOffsetPrompt), currentUnits);
            
            const description = prompt('Enter description (optional):') || '';
            
            addStage(stageType.toLowerCase(), parseInt(stageNumber), parseInt(gpioPin), tempOffsetCelsius, description);
        }

        // Add new stage
        async function addStage(stageType, stageNumber, gpioPin, tempOffset, description) {
            try {
                const response = await fetch('/api/hvac-stages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stage_type: stageType,
                        stage_number: stageNumber,
                        gpio_pin: gpioPin,
                        temp_offset: tempOffset,
                        description: description,
                        min_run_time: 300,
                        enabled: true
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add stage');
                }
                
                showMessage('Stage added successfully');
                loadStages();
            } catch (error) {
                console.error('Error adding stage:', error);
                showMessage('Error adding stage: ' + error.message, true);
            }
        }

        // Save display preferences (temperature units and theme)
        async function saveDisplayPreferences() {
            const button = document.getElementById('save-prefs-button');
            button.disabled = true;
            button.textContent = 'Saving...';
            
            try {
                // Get selected units
                const unitsRadio = document.querySelector('input[name="units"]:checked');
                if (!unitsRadio) {
                    throw new Error('Please select temperature units');
                }
                const units = unitsRadio.value;
                
                // Save temperature units to server
                const response = await fetch('/api/control/units', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ units })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update units');
                }
                
                // Get selected theme
                const themeRadio = document.querySelector('input[name="theme"]:checked');
                if (!themeRadio) {
                    throw new Error('Please select theme mode');
                }
                const theme = themeRadio.value;
                
                // Save theme to localStorage
                localStorage.setItem('theme', theme);
                
                // Apply theme
                const root = document.documentElement;
                root.classList.remove('light-mode', 'dark-mode');
                
                if (theme === 'light') {
                    root.classList.add('light-mode');
                } else if (theme === 'dark') {
                    root.classList.add('dark-mode');
                } else {
                    // Auto mode - check system preference
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        root.classList.add('dark-mode');
                    } else {
                        root.classList.add('light-mode');
                    }
                }
                
                // Update theme toggle button icon
                const isDark = root.classList.contains('dark-mode');
                document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                
                // Trigger custom event for theme change
                window.dispatchEvent(new CustomEvent('themechange', { detail: { theme, isDark } }));
                
                showMessage('Display preferences saved successfully');
                
                // Reload page after short delay to show new units everywhere
                setTimeout(() => window.location.reload(), 1500);
                
            } catch (error) {
                console.error('Error saving preferences:', error);
                showMessage('Error saving preferences: ' + error.message, true);
            } finally {
                button.disabled = false;
                button.textContent = 'Save Display Preferences';
            }
        }

        // Initial load
        loadUnits();
        loadSensors();
        loadStages();

        // Refresh periodically
        setInterval(loadSensors, 30000); // Every 30 seconds
        setInterval(loadStages, 60000);  // Every 60 seconds
    </script>
</body>
</html>
