<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Thermostat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <style>
        /* Settings-specific styles */
        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .setting-item {
            padding: 15px;
            margin-bottom: 10px;
            background: var(--sensor-bg);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-item > div > label {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
            margin-bottom: 5px;
        }

        .setting-description {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
            line-height: 1.4;
        }

        .setting-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sensor-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .sensor-header-row {
            display: grid;
            grid-template-columns: 1fr 300px 100px 120px;
            gap: 10px;
            padding: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .sensor-header-row div:nth-child(3) {
            text-align: center;
        }

        .sensor-header-row div:nth-child(4) {
            text-align: center;
        }

        .sensor-card {
            display: grid;
            grid-template-columns: 1fr 300px 100px 120px;
            gap: 10px;
            align-items: center;
            padding: 15px 12px;
            background: var(--sensor-bg);
            border-radius: 6px;
            border: 1px solid transparent;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .sensor-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--border-color);
        }

        .sensor-name-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .sensor-name-section strong {
            font-size: 1em;
            color: var(--text-primary);
        }

        .sensor-id {
            font-family: monospace;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .sensor-input-section {
            display: flex;
            align-items: center;
        }

        .sensor-input-section label {
            display: none;
        }

        .sensor-input-section input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .sensor-input-section input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sensor-enabled-section {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sensor-save-section {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sensor-save-section .save-button {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .checkbox-label {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin: 0;
            flex-shrink: 0;
            vertical-align: middle;
        }
        
        /* Ensure text is vertically centered with checkbox */
        .checkbox-label span,
        .stage-field .checkbox-label {
            display: inline-flex;
            align-items: center;
        }

        .save-button {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .save-button:hover {
            background: #2ecc71;
            transform: translateY(-1px);
        }

        .save-button:active {
            transform: translateY(0);
        }

        .save-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .radio-label input[type="radio"] {
            cursor: pointer;
        }

        .info-box {
            padding: 15px;
            background: var(--info-bg);
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .info-box p {
            margin: 5px 0;
            line-height: 1.5;
        }

        .info-box strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .success-message, .error-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Stage configuration styles */
        .stage-control-row {
            padding: 12px;
            background: var(--sensor-bg);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .stage-control-row:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Stage title - hidden on desktop, shown on mobile */
        .stage-title {
            display: none;
        }

        /* Stage fields wrapper - desktop grid layout */
        .stage-fields {
            display: grid;
            grid-template-columns: 80px 70px 90px 110px 120px 1fr 80px 100px;
            gap: 10px;
            align-items: center;
        }

        /* Style for type display field */
        .stage-field strong {
            display: flex;
            align-items: center;
            height: 100%;
        }

        /* Hide labels on desktop - they're shown in the header */
        .stage-control-row label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.85em;
            display: none;
            margin-bottom: 2px;
        }

        /* Exception: show checkbox labels inline on desktop */
        .stage-control-row .checkbox-label {
            display: flex;
        }

        .stage-control-row input[type="number"],
        .stage-control-row input[type="text"] {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 0.95em;
            width: 100%;
        }

        .stage-control-row input[type="number"]:focus,
        .stage-control-row input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stage-control-row .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }

        .stage-control-row .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        .stage-header {
            display: grid;
            grid-template-columns: 80px 70px 90px 110px 120px 1fr 80px 100px;
            gap: 10px;
            padding: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .stage-header div:nth-child(7) {
            text-align: center;
        }

        .delete-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .delete-button:hover {
            background: #c0392b;
        }

        /* Dark mode improvements */
        @media (prefers-color-scheme: dark) {
            :root:not(.light-mode) .info-box {
                background: rgba(102, 126, 234, 0.15);
                border-left-color: #a78bfa;
                color: #e2e8f0;
            }

            :root:not(.light-mode) .sensor-card {
                background: #1f2937;
                border-color: #374151;
            }

            :root:not(.light-mode) .setting-item {
                background: #1f2937;
            }

            :root:not(.light-mode) .setting-item > div > label {
                color: #f3f4f6;
            }

            :root:not(.light-mode) .sensor-control-row label,
            :root:not(.light-mode) .stage-control-row label,
            :root:not(.light-mode) .setting-item label {
                color: #e2e8f0;
            }

            :root:not(.light-mode) .sensor-control-row input[type="text"],
            :root:not(.light-mode) .stage-control-row input[type="number"],
            :root:not(.light-mode) .stage-control-row input[type="text"] {
                background: #1f2937;
                border: 1px solid #4b5563;
                color: #f3f4f6;
            }

            :root:not(.light-mode) .stage-control-row:hover {
                background: #2d3748;
            }

            :root:not(.light-mode) .stage-control-row input[type="number"]:focus,
            :root:not(.light-mode) .stage-control-row input[type="text"]:focus {
                border-color: #a78bfa;
                background: #111827;
                box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
            }

            :root:not(.light-mode) .delete-button {
                background: #dc2626;
            }

            :root:not(.light-mode) .delete-button:hover {
                background: #b91c1c;
            }

            :root:not(.light-mode) .stage-control-row strong {
                color: #f3f4f6;
            }

            :root:not(.light-mode) .sensor-id {
                color: #9ca3af;
            }

            :root:not(.light-mode) .sensor-input-section input[type="text"] {
                background: #1f2937;
                border: 1px solid #4b5563;
                color: #f3f4f6;
            }

            :root:not(.light-mode) .sensor-input-section input[type="text"]:focus {
                border-color: #a78bfa;
                background: #111827;
                box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
            }

            :root:not(.light-mode) .setting-description {
                color: #cbd5e0;
            }

            :root:not(.light-mode) .sensor-header strong {
                color: #f3f4f6;
            }

            :root:not(.light-mode) .success-message {
                background: rgba(72, 187, 120, 0.2);
                color: #86efac;
                border-color: #48bb78;
            }

            :root:not(.light-mode) .error-message {
                background: rgba(245, 101, 101, 0.2);
                color: #fca5a5;
                border-color: #f56565;
            }
        }

        /* Light mode explicit overrides */
        .light-mode .stage-control-row input[type="number"],
        .light-mode .stage-control-row input[type="text"],
        .light-mode .sensor-control-row input[type="text"] {
            background: white;
            border: 1px solid #e2e8f0;
            color: #333;
        }

        :root.dark-mode .info-box {
            background: rgba(102, 126, 234, 0.15);
            border-left-color: #a78bfa;
            color: #e2e8f0;
        }

        :root.dark-mode .sensor-card {
            background: #1f2937;
            border-color: #374151;
        }

        :root.dark-mode .setting-item {
            background: #1f2937;
        }

        :root.dark-mode .setting-item > div > label {
            color: #f3f4f6;
        }

        :root.dark-mode .sensor-control-row label,
        :root.dark-mode .setting-item label {
            color: #e2e8f0;
        }

        :root.dark-mode .sensor-control-row input[type="text"] {
            background: #374151;
            border: 1px solid #4b5563;
            color: #e2e8f0;
        }

        :root.dark-mode .sensor-id {
            color: #9ca3af;
        }

        :root.dark-mode .sensor-input-section input[type="text"] {
            background: #1f2937;
            border: 1px solid #4b5563;
            color: #f3f4f6;
        }

        :root.dark-mode .sensor-input-section input[type="text"]:focus {
            border-color: #a78bfa;
            background: #111827;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }

        :root.dark-mode .setting-description {
            color: #cbd5e0;
        }

        :root.dark-mode .sensor-header strong {
            color: #f3f4f6;
        }

        :root.dark-mode .success-message {
            background: rgba(72, 187, 120, 0.2);
            color: #86efac;
            border-color: #48bb78;
        }

        :root.dark-mode .error-message {
            background: rgba(245, 101, 101, 0.2);
            color: #fca5a5;
            border-color: #f56565;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            /* General mobile optimizations */
            .container {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .settings-section {
                margin-bottom: 20px;
            }

            .settings-section h2 {
                font-size: 1.3em;
                margin-bottom: 12px;
            }

            /* Setting items */
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px;
            }

            .setting-item label {
                font-size: 0.95em;
            }

            .setting-description {
                font-size: 0.85em;
            }

            /* Radio groups - stack vertically on mobile */
            .radio-group {
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }

            .radio-label {
                width: 100%;
                padding: 4px 0;
                font-size: 0.95em;
            }

            /* Info boxes */
            .info-box {
                padding: 12px;
                font-size: 0.85em;
            }

            .info-box p {
                font-size: 0.85em;
            }

            /* Sensor configuration */
            .sensor-header-row {
                display: none;
            }

            .sensor-list {
                gap: 15px;
            }

            .sensor-card {
                display: flex;
                flex-direction: column;
                gap: 12px;
                padding: 15px;
                border: 1px solid var(--border-color);
            }

            .sensor-name-section {
                padding-bottom: 10px;
                border-bottom: 1px solid var(--border-color);
            }

            .sensor-input-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .sensor-input-section label {
                display: block !important;
                font-weight: 600;
                font-size: 0.85em;
                color: var(--text-secondary);
            }

            .sensor-enabled-section {
                justify-content: flex-start;
            }

            .sensor-enabled-section .checkbox-label {
                font-size: 0.95em !important;
            }

            .sensor-save-section .save-button {
                width: 100%;
            }

            .sensor-id {
                font-size: 0.75em;
            }

            /* Stage configuration - completely redesign for mobile */
            .stage-header {
                display: none; /* Hide desktop header on mobile */
            }

            .stage-control-row {
                padding: 15px;
                font-size: 0.85em;
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
            }

            /* Show stage title on mobile */
            .stage-title {
                display: block !important;
                font-size: 1.1em;
                padding-bottom: 8px;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 12px;
            }

            /* Stage fields in responsive grid on mobile */
            .stage-fields {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            /* Stage fields display as column */
            .stage-field {
                display: flex;
                flex-direction: column;
            }

            /* Hide the Type field on mobile since it's in the title */
            .stage-field:first-child {
                display: none;
            }

            /* Description and delete button span full width */
            .stage-field-wide,
            .stage-field:has(.delete-button) {
                grid-column: 1 / -1;
            }

            /* Show labels on mobile */
            .stage-control-row label {
                display: block !important;
                margin-bottom: 4px;
                font-weight: 600;
                font-size: 0.8em;
            }

            .stage-control-row input[type="number"],
            .stage-control-row input[type="text"] {
                width: 100%;
                font-size: 0.9em;
            }

            .stage-control-row .checkbox-label {
                justify-content: flex-start;
                padding: 8px 0;
                flex-direction: row !important;
                font-size: 0.95em !important;
            }

            /* Buttons */
            .save-button {
                width: 100%;
                padding: 12px 16px;
                font-size: 0.95em;
            }

            .delete-button {
                width: 100%;
                padding: 10px;
            }

            /* Success/error messages */
            .success-message,
            .error-message {
                font-size: 0.9em;
                padding: 10px;
            }
        }

        /* Extra small devices (< 480px) */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .card {
                padding: 12px;
            }

            .settings-section h2 {
                font-size: 1.2em;
            }

            .setting-item {
                padding: 10px;
            }

            .info-box {
                padding: 10px;
                font-size: 0.8em;
            }

            .sensor-card {
                padding: 12px;
            }

            .stage-control-row {
                padding: 12px;
                gap: 6px;
            }

            .save-button {
                padding: 10px 12px;
                font-size: 0.9em;
            }

            /* Make radio buttons larger for easier tapping */
            .radio-label input[type="radio"],
            .checkbox-label input[type="checkbox"] {
                width: 22px;
                height: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <div class="hamburger" onclick="toggleNav()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="nav-links" id="nav-links">
                <a href="/">Dashboard</a>
                <a href="/schedules">Schedules</a>
                <a href="/history" class="history-toggle collapsed" onclick="toggleHistoryMenu(event)">History</a>
                <!-- History sub-navigation (mobile only) -->
                <div class="history-subnav" id="history-subnav">
                    <a href="/history#stats">üìä Stats</a>
                    <a href="/history#settings">‚öôÔ∏è Settings</a>
                    <a href="/history#hvac">üî• HVAC</a>
                    <a href="/history#sensors">üå°Ô∏è Sensors</a>
                </div>
                <a href="/settings" class="active">Settings</a>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
                <span id="theme-icon">üåô</span>
            </button>
        </div>

        <div id="messages"></div>

        <!-- Temperature Units Section -->
        <section class="settings-section">
            <div class="card">
                <h2>Display Preferences</h2>
                
                <div class="setting-item">
                    <div>
                        <label>Temperature Units</label>
                        <div class="setting-description">Choose how temperatures are displayed throughout the interface</div>
                    </div>
                    <div class="setting-control">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="units" value="F" id="units-f">
                                Fahrenheit (¬∞F)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="units" value="C" id="units-c">
                                Celsius (¬∞C)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="units" value="K" id="units-k">
                                Kelvin (K)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="setting-item">
                    <div>
                        <label>Theme Mode</label>
                        <div class="setting-description">Choose between light mode, dark mode, or follow system preference</div>
                    </div>
                    <div class="setting-control">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="theme" value="auto" id="theme-auto">
                                Auto (System)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="theme" value="light" id="theme-light">
                                Light
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="theme" value="dark" id="theme-dark">
                                Dark
                            </label>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="save-button" id="save-prefs-button" onclick="saveDisplayPreferences()">
                        Save Display Preferences
                    </button>
                </div>
            </div>
        </section>

        <!-- HVAC Stage Configuration Section -->
        <section class="settings-section">
            <div class="card">
                <h2>HVAC Stage Configuration</h2>
                
                <div class="info-box">
                    <p><strong>Multi-Stage HVAC:</strong> Configure heating and cooling stages for complex HVAC systems</p>
                    <p><strong>Stage Number:</strong> Stages activate progressively (1, then 2, then 3, etc.) based on temperature need</p>
                    <p><strong>GPIO Pin:</strong> BCM pin number controlling the relay for this stage</p>
                    <p><strong>Temp Offset:</strong> Temperature difference from target needed to activate this stage (stored internally as ¬∞C)</p>
                    <p><strong>Min Run Time:</strong> Minimum seconds stage must run before shutting off (prevents short-cycling)</p>
                </div>

                <div class="stage-list" id="stage-list">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        Loading stages...
                    </div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button id="save-stages-button" class="save-button" onclick="saveStageChanges()" disabled>
                        Save Changes
                    </button>
                    <button class="save-button" onclick="showAddStageDialog()">
                        Add New Stage
                    </button>
                </div>
            </div>
        </section>

        <!-- Sensor Configuration Section -->
        <section class="settings-section">
            <div class="card">
                <h2>Sensor Configuration</h2>
                
                <div class="info-box">
                    <p><strong>Sensor Names:</strong> Give each sensor a meaningful name (e.g., "Living Room", "Bedroom")</p>
                    <p><strong>Enabled:</strong> Include sensor in temperature calculations. Enabled sensors are automatically monitored for
                        anomalies like rapid temperature changes (e.g., fireplace turning on) and will be temporarily excluded from HVAC
                        control when anomalies are detected.</p>
                </div>

                <div class="sensor-list" id="sensor-list">
                    <!-- Sensors will be loaded here dynamically -->
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        Loading sensors...
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script>
        let currentSensors = [];
        let currentStages = [];
        let currentUnits = 'F';  // Default to Fahrenheit
        let modifiedStages = new Set();  // Track which stages have unsaved changes

        // Temperature conversion functions
        // NOTE: These convert temperature DIFFERENCES (deltas), not absolute temperatures
        // For deltas, we don't add/subtract the offset (32 for F, 273.15 for K)
        function celsiusToUser(tempC, units) {
            if (units === 'F') {
                return tempC * 9/5;  // Just the ratio, no +32 for differences
            } else if (units === 'K') {
                return tempC;  // Kelvin and Celsius have same delta
            }
            return tempC;  // Already Celsius
        }

        function userToCelsius(temp, units) {
            if (units === 'F') {
                return temp * 5/9;  // Just the ratio, no -32 for differences
            } else if (units === 'K') {
                return temp;  // Kelvin and Celsius have same delta
            }
            return temp;  // Already Celsius
        }

        function getUnitSymbol(units) {
            return units === 'F' ? '¬∞F' : (units === 'K' ? 'K' : '¬∞C');
        }

        // Show message to user
        function showMessage(message, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isError ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, 5000);
        }

        // Load current temperature units and theme preferences
        async function loadUnits() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                currentUnits = data.temperature_units || 'F';
                
                document.getElementById(`units-${currentUnits.toLowerCase()}`).checked = true;
                
                // Load theme preference
                const savedTheme = localStorage.getItem('theme') || 'auto';
                document.getElementById(`theme-${savedTheme}`).checked = true;
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }

        // Load sensors
        async function loadSensors() {
            try {
                const response = await fetch('/api/sensors/config');
                const data = await response.json();
                currentSensors = data.sensors || [];
                
                renderSensors();
            } catch (error) {
                console.error('Error loading sensors:', error);
                showMessage('Error loading sensors: ' + error.message, true);
            }
        }

        // Render sensor list
        function renderSensors() {
            const container = document.getElementById('sensor-list');
            
            if (currentSensors.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No sensors configured. Sensors will appear here when detected.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="sensor-header-row">
                    <div>Sensor Name / ID</div>
                    <div>Display Name</div>
                    <div>Enabled</div>
                    <div>Actions</div>
                </div>
            `;
            
            currentSensors.forEach(sensor => {
                const card = document.createElement('div');
                card.className = 'sensor-card';
                card.innerHTML = `
                    <div class="sensor-name-section">
                        <strong>${escapeHtml(sensor.sensor_id)}</strong>
                    </div>
                    <div class="sensor-input-section">
                        <label for="name-${escapeHtml(sensor.sensor_id)}">Display Name:</label>
                        <input 
                            type="text" 
                            id="name-${escapeHtml(sensor.sensor_id)}"
                            value="${escapeHtml(sensor.name || '')}"
                            placeholder="e.g., Living Room"
                            data-sensor-id="${escapeHtml(sensor.sensor_id)}"
                        >
                    </div>
                    <div class="sensor-enabled-section">
                        <label class="checkbox-label">
                            <input 
                                type="checkbox" 
                                id="enabled-${escapeHtml(sensor.sensor_id)}"
                                ${sensor.enabled ? 'checked' : ''}
                                data-sensor-id="${escapeHtml(sensor.sensor_id)}"
                            >
                            <span>Enabled</span>
                        </label>
                    </div>
                    <div class="sensor-save-section">
                        <button class="save-button" onclick="saveSensor('${escapeHtml(sensor.sensor_id)}')">
                            Save
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Save sensor configuration
        async function saveSensor(sensorId) {
            const nameInput = document.getElementById(`name-${sensorId}`);
            const enabledInput = document.getElementById(`enabled-${sensorId}`);
            
            const saveButton = event.target;
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            
            try {
                const response = await fetch(`/api/sensors/config/${encodeURIComponent(sensorId)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: nameInput.value,
                        enabled: enabledInput.checked,
                        monitored: enabledInput.checked
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save sensor');
                }
                
                showMessage(`Sensor "${nameInput.value || sensorId}" saved successfully`);
                
                // Update local data
                const sensor = currentSensors.find(s => s.sensor_id === sensorId);
                if (sensor) {
                    sensor.name = nameInput.value;
                    sensor.enabled = enabledInput.checked;
                    sensor.monitored = enabledInput.checked;
                }
                
            } catch (error) {
                console.error('Error saving sensor:', error);
                showMessage('Error saving sensor: ' + error.message, true);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== HVAC STAGE MANAGEMENT =====
        
        // Load HVAC stages
        async function loadStages() {
            try {
                const response = await fetch('/api/hvac-stages');
                const data = await response.json();
                currentStages = data || [];
                
                // Clear any pending modifications when reloading
                modifiedStages.clear();
                
                renderStages();
                updateSaveButtonState();
            } catch (error) {
                console.error('Error loading stages:', error);
                showMessage('Error loading HVAC stages: ' + error.message, true);
            }
        }

        // Render stage list
        function renderStages() {
            const container = document.getElementById('stage-list');
            
            if (currentStages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No HVAC stages configured yet. Click "Add New Stage" to configure your HVAC system.
                    </div>
                `;
                return;
            }
            
            // Sort stages by type and number
            const sortedStages = [...currentStages].sort((a, b) => {
                if (a.stage_type !== b.stage_type) {
                    return a.stage_type === 'heat' ? -1 : 1;
                }
                return a.stage_number - b.stage_number;
            });
            
            container.innerHTML = `
                <div class="stage-header">
                    <div>Type</div>
                    <div>Stage</div>
                    <div>GPIO Pin</div>
                    <div>Temp Offset (${getUnitSymbol(currentUnits)})</div>
                    <div>Min Run Time (s)</div>
                    <div>Description</div>
                    <div>Enabled</div>
                    <div>Actions</div>
                </div>
            `;
            
            sortedStages.forEach(stage => {
                // Convert temp_offset from Celsius to user units for display
                const tempOffsetDisplay = celsiusToUser(stage.temp_offset, currentUnits);
                
                const row = document.createElement('div');
                row.className = 'stage-control-row';
                row.id = `stage-row-${stage.id}`;
                row.innerHTML = `
                    <div class="stage-title"><strong>${stage.stage_type.toUpperCase()} Stage ${stage.stage_number}</strong></div>
                    <div class="stage-fields">
                        <div class="stage-field">
                            <label>Type</label>
                            <strong>${stage.stage_type.toUpperCase()}</strong>
                        </div>
                        <div class="stage-field">
                            <label>Stage Number</label>
                            <input type="number" value="${stage.stage_number}" data-stage-id="${stage.id}" data-field="stage_number" oninput="markStageModified(${stage.id})" min="1" max="10">
                        </div>
                        <div class="stage-field">
                            <label>GPIO Pin</label>
                            <input type="number" value="${stage.gpio_pin}" data-stage-id="${stage.id}" data-field="gpio_pin" oninput="markStageModified(${stage.id})" min="0" max="27">
                        </div>
                        <div class="stage-field">
                            <label>Temp Offset (${getUnitSymbol(currentUnits)})</label>
                            <input type="number" step="0.1" value="${tempOffsetDisplay.toFixed(2)}" data-stage-id="${stage.id}" data-field="temp_offset" data-needs-conversion="true" oninput="markStageModified(${stage.id})" min="0" max="${currentUnits === 'F' ? 18 : 10}">
                        </div>
                        <div class="stage-field">
                            <label>Min Run Time (s)</label>
                            <input type="number" value="${stage.min_run_time}" data-stage-id="${stage.id}" data-field="min_run_time" oninput="markStageModified(${stage.id})" min="60" max="3600">
                        </div>
                        <div class="stage-field stage-field-wide">
                            <label>Description</label>
                            <input type="text" value="${escapeHtml(stage.description || '')}" data-stage-id="${stage.id}" data-field="description" oninput="markStageModified(${stage.id})" placeholder="e.g., Primary heat">
                        </div>
                        <div class="stage-field">
                            <label class="checkbox-label">
                                <input type="checkbox" ${stage.enabled ? 'checked' : ''} data-stage-id="${stage.id}" data-field="enabled" onchange="markStageModified(${stage.id})">
                                <span>Enabled</span>
                            </label>
                        </div>
                        <div class="stage-field">
                            <button class="delete-button" onclick="deleteStage(${stage.id})">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // Mark stage as modified
        function markStageModified(stageId) {
            modifiedStages.add(stageId);
            const row = document.getElementById(`stage-row-${stageId}`);
            if (row) {
                row.style.backgroundColor = 'var(--info-bg)';
                row.style.borderLeft = '3px solid var(--accent-color)';
            }
            updateSaveButtonState();
        }

        // Update save button state
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-stages-button');
            if (saveButton) {
                saveButton.disabled = modifiedStages.size === 0;
                saveButton.textContent = modifiedStages.size > 0 ? `Save Changes (${modifiedStages.size})` : 'Save Changes';
            }
        }

        // Save all modified stages
        async function saveStageChanges() {
            if (modifiedStages.size === 0) return;

            const saveButton = document.getElementById('save-stages-button');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            let successCount = 0;
            let errorCount = 0;

            for (const stageId of modifiedStages) {
                try {
                    // Collect all field values from inputs
                    const inputs = document.querySelectorAll(`[data-stage-id="${stageId}"]`);
                    const updates = {};

                    inputs.forEach(input => {
                        const field = input.dataset.field;
                        let value;

                        if (input.type === 'checkbox') {
                            value = input.checked;
                        } else if (input.type === 'number') {
                            value = parseFloat(input.value);
                            // Convert temperature offset from user units to Celsius
                            if (field === 'temp_offset' && input.dataset.needsConversion === 'true') {
                                value = userToCelsius(value, currentUnits);
                            }
                        } else {
                            value = input.value;
                        }

                        updates[field] = value;
                    });

                    const response = await fetch(`/api/hvac-stages/${stageId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updates)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update stage');
                    }

                    // Update local data
                    const stage = currentStages.find(s => s.id === stageId);
                    if (stage) {
                        Object.assign(stage, updates);
                    }

                    // Remove modified styling
                    const row = document.getElementById(`stage-row-${stageId}`);
                    if (row) {
                        row.style.backgroundColor = '';
                        row.style.borderLeft = '';
                    }

                    successCount++;
                } catch (error) {
                    console.error(`Error updating stage ${stageId}:`, error);
                    errorCount++;
                }
            }

            modifiedStages.clear();
            updateSaveButtonState();

            if (errorCount > 0) {
                showMessage(`Saved ${successCount} stage(s), ${errorCount} failed`, true);
                loadStages();  // Reload to show original values for failed updates
            } else {
                showMessage(`Successfully saved ${successCount} stage(s)`);
            }
        }

        // Delete stage
        async function deleteStage(stageId) {
            if (!confirm('Are you sure you want to delete this HVAC stage? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hvac-stages/${stageId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete stage');
                }
                
                showMessage('Stage deleted successfully');
                loadStages();
            } catch (error) {
                console.error('Error deleting stage:', error);
                showMessage('Error deleting stage: ' + error.message, true);
            }
        }

        // Show add stage dialog
        function showAddStageDialog() {
            const stageType = prompt('Enter stage type (heat or cool):');
            if (!stageType || !['heat', 'cool'].includes(stageType.toLowerCase())) {
                if (stageType !== null) {
                    alert('Invalid stage type. Must be "heat" or "cool".');
                }
                return;
            }
            
            const stageNumber = prompt('Enter stage number (1, 2, 3, etc.):');
            if (!stageNumber || isNaN(stageNumber) || stageNumber < 1) {
                if (stageNumber !== null) {
                    alert('Invalid stage number. Must be a positive integer.');
                }
                return;
            }
            
            const gpioPin = prompt('Enter GPIO pin number:');
            if (!gpioPin || isNaN(gpioPin) || gpioPin < 0) {
                if (gpioPin !== null) {
                    alert('Invalid GPIO pin. Must be a non-negative integer.');
                }
                return;
            }
            
            const tempOffsetPrompt = prompt(`Enter temperature offset in ${getUnitSymbol(currentUnits)} (e.g., 0.5 for activation when ${currentUnits === 'F' ? '0.5¬∞F' : '0.5¬∞C'} above target):`);
            if (!tempOffsetPrompt || isNaN(tempOffsetPrompt)) {
                if (tempOffsetPrompt !== null) {
                    alert('Invalid temperature offset. Must be a number.');
                }
                return;
            }
            
            // Convert user input to Celsius for storage
            const tempOffsetCelsius = userToCelsius(parseFloat(tempOffsetPrompt), currentUnits);
            
            const description = prompt('Enter description (optional):') || '';
            
            addStage(stageType.toLowerCase(), parseInt(stageNumber), parseInt(gpioPin), tempOffsetCelsius, description);
        }

        // Add new stage
        async function addStage(stageType, stageNumber, gpioPin, tempOffset, description) {
            try {
                const response = await fetch('/api/hvac-stages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stage_type: stageType,
                        stage_number: stageNumber,
                        gpio_pin: gpioPin,
                        temp_offset: tempOffset,
                        description: description,
                        min_run_time: 300,
                        enabled: true
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add stage');
                }
                
                showMessage('Stage added successfully');
                loadStages();
            } catch (error) {
                console.error('Error adding stage:', error);
                showMessage('Error adding stage: ' + error.message, true);
            }
        }

        // Save display preferences (temperature units and theme)
        async function saveDisplayPreferences() {
            const button = document.getElementById('save-prefs-button');
            button.disabled = true;
            button.textContent = 'Saving...';
            
            try {
                // Get selected units
                const unitsRadio = document.querySelector('input[name="units"]:checked');
                if (!unitsRadio) {
                    throw new Error('Please select temperature units');
                }
                const units = unitsRadio.value;
                
                // Save temperature units to server
                const response = await fetch('/api/control/units', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ units })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update units');
                }
                
                // Get selected theme
                const themeRadio = document.querySelector('input[name="theme"]:checked');
                if (!themeRadio) {
                    throw new Error('Please select theme mode');
                }
                const theme = themeRadio.value;
                
                // Save theme to localStorage
                localStorage.setItem('theme', theme);
                
                // Apply theme
                const root = document.documentElement;
                root.classList.remove('light-mode', 'dark-mode');
                
                if (theme === 'light') {
                    root.classList.add('light-mode');
                } else if (theme === 'dark') {
                    root.classList.add('dark-mode');
                } else {
                    // Auto mode - check system preference
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        root.classList.add('dark-mode');
                    } else {
                        root.classList.add('light-mode');
                    }
                }
                
                // Update theme toggle button icon
                const isDark = root.classList.contains('dark-mode');
                document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                
                // Trigger custom event for theme change
                window.dispatchEvent(new CustomEvent('themechange', { detail: { theme, isDark } }));
                
                showMessage('Display preferences saved successfully');
                
                // Reload page after short delay to show new units everywhere
                setTimeout(() => window.location.reload(), 1500);
                
            } catch (error) {
                console.error('Error saving preferences:', error);
                showMessage('Error saving preferences: ' + error.message, true);
            } finally {
                button.disabled = false;
                button.textContent = 'Save Display Preferences';
            }
        }

        // Initial load
        loadUnits();
        loadSensors();
        loadStages();

        // Refresh periodically
        setInterval(loadSensors, 30000); // Every 30 seconds
        setInterval(loadStages, 60000);  // Every 60 seconds
    </script>
</body>
</html>
