<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thermostat Schedules</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <style>
        /* Schedules-specific styles */
        :root {
            --input-bg: #ffffff;
            --input-border: #cbd5e0;
        }

        @media (prefers-color-scheme: dark) {
            :root:not(.light-mode) {
                --input-bg: #374151;
                --input-border: #4a5568;
            }
        }

        :root.dark-mode {
            --input-bg: #374151;
            --input-border: #4a5568;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .schedule-list {
            list-style: none;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--input-bg);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .schedule-item.disabled {
            opacity: 0.6;
            border-left-color: var(--border-color);
        }

        .schedule-info h3 {
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .schedule-details {
            color: var(--text-tertiary);
            font-size: 0.9em;
        }

        .schedule-actions {
            display: flex;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 20px 60px var(--shadow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            font-size: 1em;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: #edf2f7;
            border-radius: 5px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
        }

        @media (max-width: 768px) {
            .schedule-item {
                flex-direction: column;
                gap: 15px;
            }

            .schedule-actions {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <div class="hamburger" onclick="toggleNav()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="nav-links" id="nav-links">
                <a href="/">Dashboard</a>
                <a href="/schedules" class="active">Schedules</a>
                <a href="/history">History</a>
                <a href="/settings">Settings</a>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
                <span id="theme-icon">ðŸŒ™</span>
            </button>
        </div>

        <div id="success-message" class="success-message"></div>
        <div id="error-message" class="error-message"></div>

        <div class="card">
            <h2>Active Schedules</h2>
            <button class="btn btn-primary" onclick="showCreateModal()" style="margin-bottom: 20px;">
                + Create New Schedule
            </button>
            <ul class="schedule-list" id="schedule-list">
                <li style="text-align: center; color: #718096;">Loading schedules...</li>
            </ul>
        </div>
    </div>

    <!-- Create/Edit Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Create Schedule</h2>
            <form id="scheduleForm" onsubmit="saveSchedule(event)">
                <input type="hidden" id="schedule-id">
                
                <div class="form-group">
                    <label for="schedule-name">Schedule Name *</label>
                    <input type="text" id="schedule-name" required placeholder="e.g., Weekday Morning">
                </div>

                <div class="form-group">
                    <label>Days of Week *</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="days" value="Mon"> Monday</label>
                        <label><input type="checkbox" name="days" value="Tue"> Tuesday</label>
                        <label><input type="checkbox" name="days" value="Wed"> Wednesday</label>
                        <label><input type="checkbox" name="days" value="Thu"> Thursday</label>
                        <label><input type="checkbox" name="days" value="Fri"> Friday</label>
                        <label><input type="checkbox" name="days" value="Sat"> Saturday</label>
                        <label><input type="checkbox" name="days" value="Sun"> Sunday</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="schedule-time">Time *</label>
                    <input type="time" id="schedule-time" required>
                </div>

                <div class="form-group">
                    <label for="schedule-heat">Heating Temperature (Â°F)</label>
                    <input type="number" id="schedule-heat" min="50" max="90" step="0.5" placeholder="Optional">
                </div>

                <div class="form-group">
                    <label for="schedule-cool">Cooling Temperature (Â°F)</label>
                    <input type="number" id="schedule-cool" min="50" max="90" step="0.5" placeholder="Optional">
                </div>

                <div class="form-group">
                    <label for="schedule-mode">HVAC Mode</label>
                    <select id="schedule-mode">
                        <option value="">No change</option>
                        <option value="heat">Heat</option>
                        <option value="cool">Cool</option>
                        <option value="auto">Auto</option>
                        <option value="off">Off</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Schedule</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script>
            function toggleNav() {
                const navLinks = document.getElementById('nav-links');
                navLinks.classList.toggle('active');
            }

        let schedules = [];

        function showMessage(message, isError = false) {
            const element = isError ? document.getElementById('error-message') : document.getElementById('success-message');
            element.textContent = message;
            element.style.display = 'block';

            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function showCreateModal() {
            document.getElementById('modal-title').textContent = 'Create Schedule';
            document.getElementById('scheduleForm').reset();
            document.getElementById('schedule-id').value = '';
            document.getElementById('scheduleModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('scheduleModal').style.display = 'none';
        }

        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                const data = await response.json();
                schedules = data.schedules || [];
                renderSchedules();
            } catch (error) {
                showMessage('Failed to load schedules: ' + error.message, true);
            }
        }

        function renderSchedules() {
            const list = document.getElementById('schedule-list');
            
            if (schedules.length === 0) {
                list.innerHTML = '<li style="text-align: center; color: #718096;">No schedules configured</li>';
                return;
            }

            list.innerHTML = schedules.map(schedule => `
                <li class="schedule-item ${schedule.enabled ? '' : 'disabled'}">
                    <div class="schedule-info">
                        <h3>${schedule.name}</h3>
                        <div class="schedule-details">
                            ${schedule.time} on ${schedule.days_of_week}
                            ${schedule.target_temp_heat ? `| Heat: ${schedule.target_temp_heat}Â°F` : ''}
                            ${schedule.target_temp_cool ? `| Cool: ${schedule.target_temp_cool}Â°F` : ''}
                            ${schedule.hvac_mode ? `| Mode: ${schedule.hvac_mode.toUpperCase()}` : ''}
                        </div>
                    </div>
                    <div class="schedule-actions">
                        <button class="btn ${schedule.enabled ? 'btn-primary' : 'btn-success'}" 
                                onclick="toggleSchedule(${schedule.id}, ${!schedule.enabled})">
                            ${schedule.enabled ? 'Disable' : 'Enable'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteSchedule(${schedule.id})">
                            Delete
                        </button>
                    </div>
                </li>
            `).join('');
        }

        async function saveSchedule(event) {
            event.preventDefault();

            const scheduleId = document.getElementById('schedule-id').value;
            const name = document.getElementById('schedule-name').value;
            const time = document.getElementById('schedule-time').value;
            const heat = document.getElementById('schedule-heat').value;
            const cool = document.getElementById('schedule-cool').value;
            const mode = document.getElementById('schedule-mode').value;

            const checkedDays = Array.from(document.querySelectorAll('input[name="days"]:checked'))
                .map(cb => cb.value);

            if (checkedDays.length === 0) {
                showMessage('Please select at least one day', true);
                return;
            }

            const data = {
                name: name,
                days_of_week: checkedDays.join(','),
                time: time,
                target_temp_heat: heat ? parseFloat(heat) : null,
                target_temp_cool: cool ? parseFloat(cool) : null,
                hvac_mode: mode || null
            };

            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create schedule');

                closeModal();
                showMessage('Schedule created successfully');
                loadSchedules();
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }

        async function toggleSchedule(id, enabled) {
            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled: enabled ? 1 : 0 })
                });

                if (!response.ok) throw new Error('Failed to update schedule');

                showMessage(`Schedule ${enabled ? 'enabled' : 'disabled'}`);
                loadSchedules();
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }

        async function deleteSchedule(id) {
            if (!confirm('Are you sure you want to delete this schedule?')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete schedule');

                showMessage('Schedule deleted');
                loadSchedules();
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('scheduleModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Load schedules on page load
        loadSchedules();
    </script>
</body>
</html>
